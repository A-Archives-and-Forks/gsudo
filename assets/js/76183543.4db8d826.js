"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[727],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var o=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,i=function(e,t){if(null==e)return{};var n,o,i={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=o.createContext({}),d=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=d(e.components);return o.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},c=o.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=d(n),m=i,h=c["".concat(s,".").concat(m)]||c[m]||u[m]||r;return n?o.createElement(h,a(a({ref:t},p),{},{components:n})):o.createElement(h,a({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,a=new Array(r);a[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,a[1]=l;for(var d=2;d<r;d++)a[d]=n[d];return o.createElement.apply(null,a)}return o.createElement.apply(null,n)}c.displayName="MDXCreateElement"},369:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return d},toc:function(){return u}});var o=n(7462),i=n(3366),r=(n(7294),n(3905)),a=["components"],l={sidebar_position:6,title:"How it works",hide_title:!0},s=void 0,d={unversionedId:"how-it-works",id:"how-it-works",title:"How it works",description:"How does it work?",source:"@site/docs/how-it-works.md",sourceDirName:".",slug:"/how-it-works",permalink:"/gsudo/docs/how-it-works",editUrl:"https://github.com/gerardog/gsudo/blob/docs/docs/docs/how-it-works.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6,title:"How it works",hide_title:!0},sidebar:"tutorialSidebar",previous:{title:"Security Considerations",permalink:"/gsudo/docs/security"},next:{title:"Troubleshooting",permalink:"/gsudo/docs/troubleshooting"}},p={},u=[{value:"How does it work?",id:"how-does-it-work",level:2},{value:"Elevation modes",id:"elevation-modes",level:2},{value:"Piped mode",id:"piped-mode",level:3},{value:"VT mode (PseudoConsole)",id:"vt-mode-pseudoconsole",level:3},{value:"Attached mode",id:"attached-mode",level:3},{value:"TokenSwitch Mode",id:"tokenswitch-mode",level:3},{value:"Should the elevated process inherit the same environment variables?",id:"should-the-elevated-process-inherit-the-same-environment-variables",level:2},{value:"How do I force one mode over the other?",id:"how-do-i-force-one-mode-over-the-other",level:2}],c={toc:u};function m(e){var t=e.components,n=(0,i.Z)(e,a);return(0,r.kt)("wrapper",(0,o.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"how-does-it-work"},"How does it work?"),(0,r.kt)("p",null,"When gsudo is invoked, an elevated instance of ",(0,r.kt)("inlineCode",{parentName:"p"},"gsudo")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"service mode")," is launched (with ",(0,r.kt)("inlineCode",{parentName:"p"},"Verb='RunAs'"),"). The service will allow one elevation (or many if the ",(0,r.kt)("inlineCode",{parentName:"p"},"credentials cache")," is enabled)."),(0,r.kt)("h2",{id:"elevation-modes"},"Elevation modes"),(0,r.kt)("p",null,"To achieve the ",(0,r.kt)("inlineCode",{parentName:"p"},"sudo")," functionality, ",(0,r.kt)("inlineCode",{parentName:"p"},"gsudo")," has 4 different mechanisms implemented."),(0,r.kt)("p",null,"In a way, each one superseded the previous one, leading to the current default ",(0,r.kt)("inlineCode",{parentName:"p"},"TokenSwitch"),"."),(0,r.kt)("p",null,"In the source code, each mode is implemented as one ",(0,r.kt)("inlineCode",{parentName:"p"},"IProcessRenderer")," (running non-elevated) and a ",(0,r.kt)("inlineCode",{parentName:"p"},"IProcessHost")," (running in the elevated service)."),(0,r.kt)("p",null,"Communication between both is done via two Named Pipes in the ",(0,r.kt)("inlineCode",{parentName:"p"},"ProtectedPrefix\\Administrators"),' namespace. One for data and another for control. Each elevation mode defines the "communication protocol", what is sent thru each pipe.'),(0,r.kt)("p",null,"These are the elevations modes implemented in ",(0,r.kt)("inlineCode",{parentName:"p"},"gsudo"),", in the order they were implemented:"),(0,r.kt)("h3",{id:"piped-mode"},"Piped mode"),(0,r.kt)("p",null,"This is a naive mechanism, implemented first more like a proof of concept (that later proved to be useful)."),(0,r.kt)("p",null,"The elevated ",(0,r.kt)("inlineCode",{parentName:"p"},"PipedProcessHost")," runs the command with its I/O redirected (For example as in ",(0,r.kt)("inlineCode",{parentName:"p"},"(input) > Elevated Process > (output)"),"), and sends all I/O to the unelevated via named pipes. "),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"PipedProcessRenderer")," captures input and display the output on screen. In this mode, keyboard input is managed by the client console (without knowledge of which app you are running), and not by the elevated command/shell, hence ",(0,r.kt)("kbd",null,"TAB")," key auto-completion doesn't work. The user experience is far from ideal."),(0,r.kt)("p",null,"The process is created with the elevated Environment Variables."),(0,r.kt)("p",null,"Pros: "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Redirection works")),(0,r.kt)("p",null,"Cons:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Apps always run in redirected mode."),(0,r.kt)("li",{parentName:"ul"},"Input only support of chars, not key presses."),(0,r.kt)("li",{parentName:"ul"},"Struggles with encoding, especially explicit code page changes.")),(0,r.kt)("h3",{id:"vt-mode-pseudoconsole"},"VT mode (PseudoConsole)"),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Side story")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"It was the day Microsoft ",(0,r.kt)("a",{parentName:"p",href:"https://devblogs.microsoft.com/commandline/windows-command-line-introducing-the-windows-pseudo-console-conpty/"},"announced Pseudo Consoles for Windows"),", I asked myself: What can PseudoConsoles be used for? a sudo for windows!!"))),(0,r.kt)("p",null,"The elevated instance runs a VT PseudoConsole, and sends all I/O it to the unelevated via named pipes."),(0,r.kt)("p",null,"The process is created with the elevated Environment Variables."),(0,r.kt)("p",null,"Pros:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Full featured console screen"),(0,r.kt)("li",{parentName:"ul"},"Full input support.")),(0,r.kt)("p",null,"Cons:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Good but not best performance (compared with the following alternatives)."),(0,r.kt)("li",{parentName:"ul"},"Apps always runs in console mode (not redirected). Redirection could be done but the result would be more like console screen recording than process redirection."),(0,r.kt)("li",{parentName:"ul"},"Struggles with encoding IF encoding or code page changes."),(0,r.kt)("li",{parentName:"ul"},"Console screen resizing still not implemented.")),(0,r.kt)("h3",{id:"attached-mode"},"Attached mode"),(0,r.kt)("p",null,"The elevated window ",(0,r.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/windows/console/attachconsole"},"'attaches'")," to the non-elevated. The bridge is actually done by Windows and ConHost. Doesn't work with I/O redirected."),(0,r.kt)("p",null,"The process is created with the elevated Environment Variables."),(0,r.kt)("p",null,"Pros:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Native console functioning. Full speed, colors, input, etc."),(0,r.kt)("li",{parentName:"ul"},"No encoding issues")),(0,r.kt)("p",null,"Cons:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Does not support redirection")),(0,r.kt)("h3",{id:"tokenswitch-mode"},"TokenSwitch Mode"),(0,r.kt)("p",null,"This is the current default mode. Using undocumented ",(0,r.kt)("inlineCode",{parentName:"p"},"kernel32")," Apis, the unelevated instance creates the new process in paused mode, then the elevated host replaces it's primary token, and its execution is resumed."),(0,r.kt)("p",null,"The process is created with the ",(0,r.kt)("strong",{parentName:"p"},"non-elevated")," context/Environment Variables."),(0,r.kt)("p",null,"Pros:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Native console functioning. Full speed, colors, input, etc."),(0,r.kt)("li",{parentName:"ul"},"No encoding issues"),(0,r.kt)("li",{parentName:"ul"},"Supports redirection")),(0,r.kt)("p",null,"Cons:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"(debatable) The new process inherits the non-elevated environment variables.")),(0,r.kt)("p",null,"This last item is a confirmed problem when the elevation is done as somebody else (i.e. the current user is not admin and ",(0,r.kt)("inlineCode",{parentName:"p"},"RunAs")," asks for credentials). To avoid it, and only in this scenario, this mode falls back to Attached mode (if no redirection) or Piped mode (if redirection exists)."),(0,r.kt)("h2",{id:"should-the-elevated-process-inherit-the-same-environment-variables"},"Should the elevated process inherit the same environment variables?"),(0,r.kt)("p",null,"Great question. If your user is a local admin, i.e. you elevate as yourself, both contexts have similar if not same env vars."),(0,r.kt)("p",null,"But if you are not local admin, UAC will prompt for credentials, and then you will be running as another user, so env var isolation becomes more important. On Linux/Unix, you always ",(0,r.kt)("inlineCode",{parentName:"p"},"sudo")," as somebody else and env vars are not preserved, unless ",(0,r.kt)("inlineCode",{parentName:"p"},"-E")," is specified. ",(0,r.kt)("inlineCode",{parentName:"p"},"gsudo")," provides ",(0,r.kt)("inlineCode",{parentName:"p"},"--copyEV")," to copy all the vars, except %USERNAME%."),(0,r.kt)("h2",{id:"how-do-i-force-one-mode-over-the-other"},"How do I force one mode over the other?"),(0,r.kt)("p",null,"You shouldn't. ",(0,r.kt)("inlineCode",{parentName:"p"},"gsudo")," should do a better job choosing than you. Still reading? Ok... I will tell you. But this is marked as deprecated and can change anytime."),(0,r.kt)("p",null,"To force Attached mode use ",(0,r.kt)("inlineCode",{parentName:"p"},"--attached")," or permanently with ",(0,r.kt)("inlineCode",{parentName:"p"},"gsudo config ForceAttachedConsole True")),(0,r.kt)("p",null,"To force Piped mode use ",(0,r.kt)("inlineCode",{parentName:"p"},"--piped")," or permanently with ",(0,r.kt)("inlineCode",{parentName:"p"},"gsudo config ForcePipedConsole True")),(0,r.kt)("p",null,"To force VT mode use ",(0,r.kt)("inlineCode",{parentName:"p"},"--vt")," or permanently with ",(0,r.kt)("inlineCode",{parentName:"p"},"gsudo config ForceVTConsole True")),(0,r.kt)("p",null,"Use only one at the same time."))}m.isMDXComponent=!0}}]);