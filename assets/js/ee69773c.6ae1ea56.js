"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[816],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>g});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=u(n),g=a,m=c["".concat(s,".").concat(g)]||c[g]||p[g]||o;return n?r.createElement(m,i(i({ref:t},d),{},{components:n})):r.createElement(m,i({ref:t},d))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},1403:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>u});var r=n(7462),a=(n(7294),n(3905));const o={slug:"gsudo-dotnet-7",title:"Migrating gsudo to .NET 7",authors:["gerardog"],tags:[]},i=void 0,l={permalink:"/gsudo/blog/gsudo-dotnet-7",editUrl:"https://github.com/gerardog/gsudo/tree/docs/docs/blog/blog/2022-08-21-dotnet7/index.md",source:"@site/blog/2022-08-21-dotnet7/index.md",title:"Migrating gsudo to .NET 7",description:"The first gsudo versions were made in 2019, around the release of .NET Core 3. I tried to figure out how .NET Core's redistribution model worked, but it didn't worked for me. One should either redistribute the full runtime, or ask the user to manually download and install it. There was another option: to build a self-cointained app (with runtime embedded) but that increased the output size by more than 80mb!",date:"2022-08-21T00:00:00.000Z",formattedDate:"August 21, 2022",tags:[],readingTime:3.495,truncated:!1,authors:[{name:"Gerardo Grignoli",url:"https://github.com/gerardog",imageURL:"https://avatars.githubusercontent.com/u/3901474?s=96&v=4",key:"gerardog"}],frontMatter:{slug:"gsudo-dotnet-7",title:"Migrating gsudo to .NET 7",authors:["gerardog"],tags:[]}},s={authorsImageUrls:[void 0]},u=[{value:"Should gsudo target .NET 7.0?",id:"should-gsudo-target-net-70",level:2},{value:"Current situation",id:"current-situation",level:2}],d={toc:u};function p(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"The first gsudo versions were made in 2019, around the release of .NET Core 3. I tried to figure out how .NET Core's redistribution model worked, but it didn't worked for me. One should either redistribute the full runtime, or ask the user to manually download and install it. There was another option: to build a self-cointained app (with runtime embedded) but that increased the output size by more than 80mb!"),(0,a.kt)("p",null,"The alternative was to target .NET Framework v4.6. This version is bundled with every Windows 10/11. When targeting it, gsudo build output size was around 100kb. The app on v4.6 loaded faster, so targeting v4.6 seemed logical. It was small, fast, and the installation didn't required any big runtime redistribution or additional steps."),(0,a.kt)("p",null,"Recently, things have changed a little with ",(0,a.kt)("a",{parentName:"p",href:"https://devblogs.microsoft.com/dotnet/announcing-dotnet-7-preview-3/#faster-lighter-apps-with-native-aot"},".NET 7 Preview 3 announcement"),' and NativeAOT: "Publishing your app as native AOT produces an app that is self-contained and that has been ahead-of-time (AOT) compiled to native code. Native AOT apps start up very quickly and use less memory. Users of the application can run it on a machine that doesn\'t have the .NET runtime installed."'),(0,a.kt)("p",null,"I'm almost sold! Let's try it out... ",(0,a.kt)("em",{parentName:"p"},"(sounds of frenetic typing)"),"... Ok, that was ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/gerardog/gsudo/compare/971ea97c...7c0c1b71"},"18 files changed"),". Now I have a multi-target project that can compile for v4.6 or v7. Not bad. "),(0,a.kt)("p",null,"But not everyone's cup of tea: NativeAOT builds for each specific platform, so instead of having one AnyCPU build, now I have two (x64 and x86). But also, NativeAOT is only supported on x64. The closest for x86 is a self-contained build with Ready2Run."),(0,a.kt)("p",null,"Let's do some test the performance. So first let\xb4s build for each platform:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"# Build .NET Framework v4.6\nmsbuild /t:Restore /p:RestorePackagesConfig=true src\\gsudo.sln /v:Minimal /p:TargetFrameworkVersion=v4.6\nmsbuild /t:Rebuild /p:Configuration=Release src\\gsudo\\gsudo.csproj /v:Minimal /p:WarningLevel=0 /p:TargetFrameworkVersion=v4.6\n# Build .NET 7.0 x64 build with NativeAOT\ndotnet clean .\\src\\gsudo\\gsudo.csproj -f net7.0 | Out-null\ndotnet publish .\\src\\gsudo\\gsudo.csproj -c Release -f net7.0 -r win-x64 --sc -p:PublishAot=true -p:IlcOptimizationPreference=Size -v minimal -p:WarningLevel=0\n# Build .NET 7.0 x86 build with Ready2Run\ndotnet clean .\\src\\gsudo\\gsudo.csproj -f net7.0 -r win-x86 | Out-null\ndotnet publish .\\src\\gsudo\\gsudo.csproj -c Release -f net7.0 -r win-x86 --sc -p:PublishReadyToRun=true -p:PublishSingleFile=true -v minimal -p:WarningLevel=0\n")),(0,a.kt)("p",null,"Now let\xb4s meassure 100 elevations using a preexisting credentials cache. I am using ",(0,a.kt)("inlineCode",{parentName:"p"},"gsudo -d")," to force an elevation using ",(0,a.kt)("inlineCode",{parentName:"p"},"cmd.exe"),", which loads much faster and predictable than ",(0,a.kt)("inlineCode",{parentName:"p"},"Powershell"),". Then I repeated the tests with each different build."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'$gsudo="C:\\git\\gsudo\\src\\gsudo\\bin\\net46\\gsudo.exe"\n& $gsudo cache on | out-null    # start a cache session.\n& $gsudo -d dir | out-null      # test the cache session.\nMeasure-Command { 1..100 | % { & $gsudo -d dir} } | select -Property TotalSeconds | Format-List\n& $gsudo -k | out-null          # close cache.\n')),(0,a.kt)("p",null,"The first results were absurd. I found out Windows Defender takes extra time to verify unsigned apps in the cloud. So I disabled Defender and started over."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null}),(0,a.kt)("th",{parentName:"tr",align:null},"v1.3.0 (Net 4.6 + ilmerge + CodeSigned)"),(0,a.kt)("th",{parentName:"tr",align:null},"Latest (Net 4.6 unsigned)"),(0,a.kt)("th",{parentName:"tr",align:null},"Net 7.0 x64 NativeAOT (unsigned)"),(0,a.kt)("th",{parentName:"tr",align:null},"Net 7.0 x86 Ready2Run (unsigned)"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Size"),(0,a.kt)("td",{parentName:"tr",align:null},"180.5 KB"),(0,a.kt)("td",{parentName:"tr",align:null},"208.5 KB"),(0,a.kt)("td",{parentName:"tr",align:null},"6.17 MB"),(0,a.kt)("td",{parentName:"tr",align:null},"16.89 MB")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Time to elevate 100 times (sum)"),(0,a.kt)("td",{parentName:"tr",align:null},"12.75 s"),(0,a.kt)("td",{parentName:"tr",align:null},"12.62 s"),(0,a.kt)("td",{parentName:"tr",align:null},"7.83 s"),(0,a.kt)("td",{parentName:"tr",align:null},"10.94 s")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Performance improvement"),(0,a.kt)("td",{parentName:"tr",align:null},"(baseline)"),(0,a.kt)("td",{parentName:"tr",align:null},"1.04%"),(0,a.kt)("td",{parentName:"tr",align:null},"38.62%"),(0,a.kt)("td",{parentName:"tr",align:null},"14.18%")))),(0,a.kt)("p",null,"Wow! An improvement of 38.62% is significant enough to ignore the fact that the file size has increased 6 MB, or almost 30 times. "),(0,a.kt)("h2",{id:"should-gsudo-target-net-70"},"Should gsudo target .NET 7.0?"),(0,a.kt)("p",null,"The problem is that the installer should provide for all platforms, and so far I\xb4ve only focused on x64. What options do I have?"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"I could fall back to Net 4.6 (targeting AnyCPU) for the remaining platforms. The down-side would be different prerequisites for each scenario. But the installer would only grow 6mb."),(0,a.kt)("li",{parentName:"ul"},"Or include x86 Net 7.0 Read2Run version. It\xb4s faster, but takes 16mb. The setup including both would  take 23 MB (actually 10mb when compressed)!  ")),(0,a.kt)("h2",{id:"current-situation"},"Current situation"),(0,a.kt)("p",null,"Right now my code-signing certificate is expired. Once I\xb4ve got a new certificate, I will be making a test release. I will update this post then."))}p.isMDXComponent=!0}}]);