"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[727],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var o=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,i=function(e,t){if(null==e)return{};var n,o,i={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=o.createContext({}),d=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=d(e.components);return o.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=d(n),m=i,h=u["".concat(s,".").concat(m)]||u[m]||c[m]||a;return n?o.createElement(h,r(r({ref:t},p),{},{components:n})):o.createElement(h,r({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,r=new Array(a);r[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var d=2;d<a;d++)r[d]=n[d];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},369:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return d},toc:function(){return c}});var o=n(7462),i=n(3366),a=(n(7294),n(3905)),r=["components"],l={sidebar_position:6,title:"How it works"},s=void 0,d={unversionedId:"how-it-works",id:"how-it-works",title:"How it works",description:"Implicit features:",source:"@site/docs/how-it-works.md",sourceDirName:".",slug:"/how-it-works",permalink:"/gsudo/docs/how-it-works",editUrl:"https://github.com/gerardog/gsudo/blob/docs/docs/docs/how-it-works.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6,title:"How it works"},sidebar:"tutorialSidebar",previous:{title:"Security Considerations",permalink:"/gsudo/docs/security"}},p={},c=[{value:"Implicit features:",id:"implicit-features",level:2},{value:"How does it work?",id:"how-does-it-work",level:2},{value:"Elevation modes",id:"elevation-modes",level:2},{value:"Piped mode:",id:"piped-mode",level:3},{value:"VT mode (PseudoConsole)",id:"vt-mode-pseudoconsole",level:3},{value:"<strong>Attached mode:</strong>",id:"attached-mode",level:3},{value:"<strong>TokenSwitch Mode:</strong>",id:"tokenswitch-mode",level:3}],u={toc:c};function m(e){var t=e.components,n=(0,i.Z)(e,r);return(0,a.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"implicit-features"},"Implicit features:"),(0,a.kt)("p",null,"When gsudo elevates, it:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Starts the desired process with elevated permissions."),(0,a.kt)("li",{parentName:"ul"},"Keeps as much of the user context as possible:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"The current directory"),(0,a.kt)("li",{parentName:"ul"},"Environment variables (*)"))),(0,a.kt)("li",{parentName:"ul"},"Allows i/o redirection."),(0,a.kt)("li",{parentName:"ul"},"Makes the elevated app show up in the non-elevated console (unless ",(0,a.kt)("inlineCode",{parentName:"li"},"-n"),")."),(0,a.kt)("li",{parentName:"ul"},"If the command is a Windows App, does not wait for it to end (unless ",(0,a.kt)("inlineCode",{parentName:"li"},"-w"),"). If it is a console app, or opened in a new window, it waits until it ends and returns its exit code."),(0,a.kt)("li",{parentName:"ul"},"Handles Ctrl-C properly"),(0,a.kt)("li",{parentName:"ul"},"Uses the current shell to interpet the command to elevate:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"This makes sense because the user will prepend ",(0,a.kt)("inlineCode",{parentName:"li"},"gsudo")," to elevate a command, which meaning depends on the current context (the current shell)."),(0,a.kt)("li",{parentName:"ul"},"For example, in PowerShell ",(0,a.kt)("inlineCode",{parentName:"li"},"gsudo mkdir x")," becames ",(0,a.kt)("inlineCode",{parentName:"li"},'pwsh -c "mkdir x"'),", while in CMD it becames ",(0,a.kt)("inlineCode",{parentName:"li"},'cmd /c "mkdir x"'),"."))),(0,a.kt)("li",{parentName:"ul"},"Support worldwide encodings & codepages")),(0,a.kt)("h2",{id:"how-does-it-work"},"How does it work?"),(0,a.kt)("p",null,"When gsudo is invoked, an elevated instance of ",(0,a.kt)("inlineCode",{parentName:"p"},"gsudo")," is launched (with ",(0,a.kt)("inlineCode",{parentName:"p"},"Verb='RunAs'"),") in ",(0,a.kt)("inlineCode",{parentName:"p"},"service mode"),". The service will allow one elevation (or many if the ",(0,a.kt)("inlineCode",{parentName:"p"},"credentials cache")," is enabled)."),(0,a.kt)("p",null,"The elevation mode"),(0,a.kt)("h2",{id:"elevation-modes"},"Elevation modes"),(0,a.kt)("p",null,"To achieve a ",(0,a.kt)("inlineCode",{parentName:"p"},"sudo")," functionallity (i.e. to launch elevated processes keeping as much of the caller context as possible) ",(0,a.kt)("inlineCode",{parentName:"p"},"gsudo")," has 4 different mechanisms implemented."),(0,a.kt)("p",null,"In a way, each one superseded the previous one, leading to the current default ",(0,a.kt)("inlineCode",{parentName:"p"},"TokenSwitch"),"."),(0,a.kt)("p",null,"In the source code, each mode is implemented as one ",(0,a.kt)("inlineCode",{parentName:"p"},"IProcessRenderer")," (running non-elevated) and a ",(0,a.kt)("inlineCode",{parentName:"p"},"IProcessHost")," (running in the elevated service). Both  communicate via the afore mentioned named pipes."),(0,a.kt)("p",null,"Communication between both is done via two Named Pipes in the ",(0,a.kt)("inlineCode",{parentName:"p"},"ProtectedPrefix\\Administrators"),' namespace. One for data and another for control. The each elevation mode defines the "communication protocol", what is sent thru each pipe.'),(0,a.kt)("h3",{id:"piped-mode"},"Piped mode:"),(0,a.kt)("p",null,"This is a naive mechanism, and the one that was implemented first, more like a proof of concept (that later prooved to be useful)."),(0,a.kt)("p",null,"The elevated ",(0,a.kt)("inlineCode",{parentName:"p"},"PipedProcessHost")," runs the command with it's I/O redirected (For example as in ",(0,a.kt)("inlineCode",{parentName:"p"},"(input) > Elevated Process > (output)"),"), and sends all I/O to the unelevated via named pipes. "),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"PipedProcessRenderer")," captures input and display the output on screen. In this mode, keyboard input is managed by the client console (without knowledge of which app you are running), and not by the elevated command/shell, hence ",(0,a.kt)("kbd",null,"TAB")," key auto-completition doesn't work. The user experience is far from ideal."),(0,a.kt)("p",null,"Pros: "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Redirection works")),(0,a.kt)("p",null,"Cons:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Apps always run in redirected mode."),(0,a.kt)("li",{parentName:"ul"},"Input only support of chars, not key presses."),(0,a.kt)("li",{parentName:"ul"},"Struggles with encoding, specially explicit code page changes.")),(0,a.kt)("h3",{id:"vt-mode-pseudoconsole"},"VT mode (PseudoConsole)"),(0,a.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"Side story: It was actually when Microsoft ",(0,a.kt)("a",{parentName:"p",href:"https://devblogs.microsoft.com/commandline/windows-command-line-introducing-the-windows-pseudo-console-conpty/"},"announced")," of Pseudo Consoles for Windows, that I asked myself: What can pseudoconsoles be used for? And then the idea "))),(0,a.kt)("p",null,"This was actually the "),(0,a.kt)("p",null,"The elevated instance runs a VT pseudoconsole, and sends all I/O it to the unelevated via named pipes. Do not resize the window in this mode, please. "),(0,a.kt)("h3",{id:"attached-mode"},(0,a.kt)("strong",{parentName:"h3"},"Attached mode:")),(0,a.kt)("p",null,"The elevated window 'attaches' to the non elevated. The bridge is actually done by Windows and ConHost. Doesn't work with I/O redirected (where Piped excels)"),(0,a.kt)("h3",{id:"tokenswitch-mode"},(0,a.kt)("strong",{parentName:"h3"},"TokenSwitch Mode:")),(0,a.kt)("p",null,"(current default) Using an undocumented api, the unelevated creates the new process in paused mode, then the elevated replaces it's token via WinApi, and its execution is resumed."),(0,a.kt)("p",null,"Or configurations:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"SecurityEnforceUacIsolation=true:")," This is piped mode with a hack where the Input is closed, making theoretically impossible for an unelevated process to drive the elevated world. I don't have real proof that this is less exploitable than the default, hence I never publicily documented this setting."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"ForceNewWindow:")," An idea (spec still pending), to add a config setting where all elevations are done in new windows, so no isolation is broken. If I/O is redirected, the result may be streamed to the unelevated. This is still only and idea because the user experience would probably be ."))}m.isMDXComponent=!0}}]);